---
import "../styles/global.css";
import {
  SignedIn,
  SignedOut,
  UserButton,
  SignInButton,
} from "@clerk/astro/components";
---

<header
  class="sticky top-0 z-50 w-full border-b border-white/10 bg-black backdrop-blur-sm"
>
  <div
    class="mx-auto flex h-16 max-w-7xl items-center justify-between px-4 sm:px-6 lg:px-8"
  >
    <a class="text-xl font-bold uppercase tracking-widest text-white" href="/">Jewelry Fashion</a>
    <nav
      class="hidden items-center space-x-4 text-xs font-medium uppercase tracking-wider text-gray-300 lg:flex lg:space-x-6"
    >
      <a class="hover:text-white" href="/about-us">Quienes somos</a>
      <a class="hover:text-white" href="/catalog">Catalogo</a>
      <a class="hover:text-white" href="/services">Servicios</a>
      <a class="hover:text-white" href="/contact">Contacto</a>
    </nav>
    <div class="flex items-center">
      <a href="/cart" class="relative flex size-10 items-center justify-center rounded-full text-white hover:bg-white/10">
        <span class="material-symbols-outlined text-2xl">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="24"
            height="24"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
            class="icon icon-tabler icons-tabler-outline icon-tabler-shopping-cart"
            ><path stroke="none" d="M0 0h24v24H0z" fill="none"></path><path
              d="M6 19m-2 0a2 2 0 1 0 4 0a2 2 0 1 0 -4 0"></path><path
              d="M17 19m-2 0a2 2 0 1 0 4 0a2 2 0 1 0 -4 0"></path><path
              d="M17 17h-11v-14h-2"></path><path d="M6 5l14 1l-1 7h-13"
            ></path></svg
          >
        </span>
        <span id="cart-count-badge" class="absolute -top-1 -right-1 inline-flex items-center justify-center min-w-[18px] h-4 px-1 rounded-full bg-primary text-white text-xs font-bold opacity-0 transition-opacity duration-200">0</span>
      </a>
      <div class="ml-4 flex items-center">
        <SignedOut>
          <SignInButton mode="modal" />
        </SignedOut>
        <SignedIn>
          <UserButton />
        </SignedIn>
      </div>
      <button
        id="menu-button"
        class="ml-2 flex size-10 items-center justify-center rounded-full text-white hover:bg-white/10 lg:hidden"
        aria-controls="mobile-menu"
        aria-expanded="false"
        aria-label="Abrir menú"
      >
        <span class="material-symbols-outlined text-2xl">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="24"
            height="24"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
            class="icon icon-tabler icons-tabler-outline icon-tabler-menu"
            ><path stroke="none" d="M0 0h24v24H0z" fill="none"></path><path
              d="M4 8l16 0"></path><path d="M4 16l16 0"></path></svg
          >
        </span>
      </button>
    </div>
  </div>
</header>

<!-- Mobile menu + overlay -->
<div
  id="mobile-overlay"
  class="fixed inset-0 z-40 bg-black/50 opacity-0 pointer-events-none transition-opacity duration-300 lg:hidden"
  aria-hidden="true"
>
</div>

<aside
  id="mobile-menu"
  class="fixed inset-y-0 right-0 z-50 w-80 max-w-full transform translate-x-full transition-transform duration-300 ease-in-out bg-black/95 p-6 lg:hidden"
  role="dialog"
  aria-modal="true"
  aria-hidden="true"
>
  <div class="flex items-center justify-between mb-6">
    <button
      id="mobile-close"
      class="text-gray-300 hover:text-white p-2 rounded"
      aria-label="Cerrar menú"
    >
      <span class="material-symbols-outlined">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="24"
          height="24"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
          class="icon icon-tabler icons-tabler-outline icon-tabler-x"
          ><path stroke="none" d="M0 0h24v24H0z" fill="none"></path><path
            d="M18 6l-12 12"></path><path d="M6 6l12 12"></path></svg
        >
      </span>
    </button>
  </div>
  <nav
    class="flex flex-col space-y-4 text-sm font-medium uppercase tracking-wider text-gray-300"
  >
    <a class="block px-2 py-2 rounded hover:text-white" href="/about-us"
      >Quienes somos</a
    >
    <a class="block px-2 py-2 rounded hover:text-white" href="/catalog">Catalogo</a>
    <a class="block px-2 py-2 rounded hover:text-white" href="/services">Servicios</a>
    <a class="block px-2 py-2 rounded hover:text-white" href="/contact">Contacto</a>
  </nav>
  <div class="mt-6 border-t border-white/5">
    <div class="flex pl-2 items-center">
      <SignedOut>
        <SignInButton mode="modal" />
      </SignedOut>
      <SignedIn>
        <UserButton />
      </SignedIn>
    </div>
  </div>
</aside>

<script type="module">
  (function () {
    const menuBtn = document.getElementById("menu-button");
    const closeBtn = document.getElementById("mobile-close");
    const mobile = document.getElementById("mobile-menu");
    const overlay = document.getElementById("mobile-overlay");

    if (!menuBtn || !mobile || !overlay) return;

    function openMenu() {
      mobile!.classList.remove("translate-x-full");
      mobile!.classList.add("translate-x-0");
      mobile!.setAttribute("aria-hidden", "false");
      overlay!.classList.remove("opacity-0", "pointer-events-none");
      overlay!.classList.add("opacity-100");
      overlay!.setAttribute("aria-hidden", "false");
      menuBtn!.setAttribute("aria-expanded", "true");
      document.documentElement.style.overflow = "hidden";
      // focus first focusable element inside menu
      setTimeout(() => {
        const focusable = mobile!.querySelector(
          'a, button, input, [tabindex]:not([tabindex="-1"])'
        );
        if (focusable) (focusable as HTMLElement).focus();
      }, 150);
    }

    function closeMenu() {
      mobile!.classList.remove("translate-x-0");
      mobile!.classList.add("translate-x-full");
      mobile!.setAttribute("aria-hidden", "true");
      overlay!.classList.remove("opacity-100");
      overlay!.classList.add("opacity-0", "pointer-events-none");
      overlay!.setAttribute("aria-hidden", "true");
      menuBtn!.setAttribute("aria-expanded", "false");
      document.documentElement.style.overflow = "";
      menuBtn!.focus();
    }

    menuBtn.addEventListener("click", (e) => {
      const expanded = menuBtn.getAttribute("aria-expanded") === "true";
      if (expanded) closeMenu();
      else openMenu();
    });

    closeBtn && closeBtn.addEventListener("click", closeMenu);
    overlay.addEventListener("click", closeMenu);

    // close on ESC
    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape") {
        const opened = mobile.classList.contains("translate-x-0");
        if (opened) closeMenu();
      }
    });
    // Cart badge handling
    const cartBadge = document.getElementById('cart-count-badge');
    function setBadge(count){
      if(!cartBadge) return;
      cartBadge.textContent = String(count || 0);
      if((count||0) > 0){ cartBadge.classList.remove('opacity-0'); cartBadge.classList.add('opacity-100'); }
      else { cartBadge.classList.remove('opacity-100'); cartBadge.classList.add('opacity-0'); }
    }
    window.addEventListener('cartchange', (e)=> setBadge(e.detail?.count));
    // initialize from API if available
    setTimeout(()=>{ if(window.cartApi && typeof window.cartApi.getCount === 'function') setBadge(window.cartApi.getCount()); }, 50);
  })();
</script>
