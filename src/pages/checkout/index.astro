---
import BaseLayout from "../../layouts/Layout.astro";
---

<BaseLayout>
  <main class="flex-grow px-4 pb-12">
    <div
      class="text-text-light text-3xl font-bold tracking-tight text-left pt-6 pb-8"
    >
      <main class="mx-auto max-w-6xl px-4 sm:px-6 lg:px-8 mt-10">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
          <section class="lg:col-span-2">
            <h2 class="text-2xl font-bold">Checkout</h2>
            <div id="cart-list" class="mt-6 bg-white rounded-lg shadow-sm p-6">
              <div id="cart-items" class="space-y-4">
                <p class="text-gray-600">Cargando carrito...</p>
              </div>
            </div>
          </section>
          <aside class="lg:col-span-1">
            <h3 class="text-lg font-semibold">Resumen</h3>
            <div class="mt-4 bg-white rounded-lg shadow-sm p-6">
              <p class="text-gray-600">
                Total: <strong id="cart-total">$0</strong>
              </p>
              <button
                id="checkout-clear"
                class="mt-4 w-full cursor-pointer rounded bg-red-500 text-white py-2"
                >Vaciar carrito</button
              >
              <button
                id="checkout-pay"
                class="mt-3 w-full cursor-pointer rounded bg-background-dark text-white py-2"
                >Pagar</button
              >
              <p
                id="checkout-pay-note"
                class="text-sm text-gray-500 mt-2 hidden"
              >
                El carrito est√° vac√≠o. A√±ade productos antes de pagar.
              </p>
            </div>
          </aside>
        </div>

        <!-- Form container -->
        <div id="checkout-form-container" class="hidden">
          <h3 class="text-xl font-semibold text-text-light mb-4">
            Datos del comprador
          </h3>

          <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <label class="flex flex-col w-full sm:col-span-2">
              <span class="text-text-dark text-sm font-medium pb-2"
                >Nombre completo</span
              >
              <input
                id="buyer-name"
                class="form-input flex w-full rounded-lg text-text-light border border-border-dark bg-surface-dark h-12 px-4"
                placeholder="Ej: Juan P√©rez"
                type="text"
                required
              />
            </label>

            <label class="flex flex-col w-full">
              <span class="text-text-dark text-sm font-medium pb-2">Email</span>
              <input
                id="buyer-email"
                class="form-input flex w-full rounded-lg text-text-light border border-border-dark bg-surface-dark h-12 px-4"
                placeholder="correo@mail.com"
                type="email"
                required
              />
            </label>

            <label class="flex flex-col w-full">
              <span class="text-text-dark text-sm font-medium pb-2"
                >Tel√©fono</span
              >
              <input
                id="buyer-phone"
                class="form-input flex w-full rounded-lg text-text-light border border-border-dark bg-surface-dark h-12 px-4"
                placeholder="3001234567"
                type="tel"
                required
              />
            </label>
          </div>

          <div class="pt-4">
            <button
              id="submit-pay"
              class="w-full rounded-lg cursor-pointer bg-primary py-4 px-6 text-center font-bold text-white"
            >
              Pagar ahora
            </button>
          </div>
        </div>
      </main>
    </div>

    <!-- MODAL WOMPI MEJORADO -->
    <div
      id="modalPago"
      style="
        display:none;
        position:fixed;
        inset:0;
        background:linear-gradient(rgba(0,0,0,0.75), rgba(0,0,0,0.85));
        backdrop-filter: blur(4px);
        z-index:9999;
      "
    >
      <div
        style="
    position:relative;
    width:90%;
    max-width:850px;
    height:80vh;
    margin:5vh auto;
    background:#ffffff;
    border-radius:22px;
    box-shadow:0 25px 60px rgba(0,0,0,0.4);
    display:flex;
    flex-direction:column;
    padding:40px 35px;
  "
      >
        <!-- Bot√≥n cerrar -->
        <button
          id="cerrarModalBtn"
          style="
      position:absolute;
      top:18px;
      right:22px;
      font-size:22px;
      background:#f2f2f2;
      border:none;
      border-radius:50%;
      width:40px;
      height:40px;
      cursor:pointer;
      transition:0.3s;
    "
          onmouseover="this.style.background='#e74c3c';this.style.color='white'"
          onmouseout="this.style.background='#f2f2f2';this.style.color='black'"
        >
          ‚úï
        </button>

        <!-- Cabecera -->
        <div style="text-align:center; margin-bottom:25px;">
          <h2 style="margin:0; font-size:28px; color:#222;">
            Finaliza tu pago de forma segura
          </h2>
          <p style="margin-top:10px; font-size:16px; color:#555;">
            Haz clic en el bot√≥n de abajo para continuar con el pago en la
            plataforma segura de <strong>Wompi</strong>.
          </p>
        </div>

        <!-- Instrucci√≥n visual -->
        <div
          style="
      background:#f8f9fa;
      border:2px dashed #6c63ff;
      padding:18px;
      border-radius:14px;
      text-align:center;
      margin-bottom:30px;
      font-size:16px;
      color:#333;
    "
        >
          üëâ Presiona el bot√≥n morado para realizar tu pago de forma segura
        </div>

        <!-- Contenedor Wompi -->
        <div
          id="wompi-container"
          style="
      flex:1;
      display:flex;
      justify-content:center;
      align-items:center;
    "
        >
          <!-- AQU√ç SE INYECTA EL BOT√ìN DE WOMPI -->
        </div>
      </div>
    </div>

    <script type="module">
      window.addEventListener("DOMContentLoaded", () => {
        const elItems = document.getElementById("cart-items");
        const elTotal = document.getElementById("cart-total");
        const btnClear = document.getElementById("checkout-clear");
        const btnShowForm = document.getElementById("checkout-pay");
        const btnSubmit = document.getElementById("submit-pay");
        const payNote = document.getElementById("checkout-pay-note");
        const formContainer = document.getElementById(
          "checkout-form-container"
        );

        const money = (v) => "$" + Number(v || 0).toFixed(2);

        function renderCart() {
          if (!window.cartApi) {
            elItems.innerHTML =
              '<p class="text-red-500">Carrito no disponible</p>';
            return;
          }

          const cart = window.cartApi.getCart() || [];
          const total = cart.reduce((s, i) => s + i.price * i.quantity, 0);

          elTotal.textContent = money(total);
          btnSubmit.textContent = `Pagar Ahora ${money(total)}`;
          btnShowForm.textContent = `Pagar ${money(total)}`;

          if (!cart.length) {
            elItems.innerHTML =
              '<p class="text-gray-600">Tu carrito est√° vac√≠o</p>';
            btnShowForm.disabled = true;
            btnSubmit.disabled = true;
            return;
          }

          btnShowForm.disabled = false;
          btnSubmit.disabled = false;

          elItems.innerHTML = "";
          cart.forEach((item) => {
            const div = document.createElement("div");
            div.className = "flex items-center gap-4";

            div.innerHTML = `
              <img src="${item.image || "/assets/placeholder.png"}" class="w-16 h-16 rounded" />
              <div class="flex-1">
                <strong>${item.name}</strong>
                <div class="text-sm">
                  ${money(item.price)} x
                  <input class="qty-input border px-1 w-14" data-id="${item.id}" value="${item.quantity}" />
                </div>
              </div>
              <button data-id="${item.id}" class="remove-btn text-red-600">Eliminar</button>
            `;

            elItems.appendChild(div);
          });

          bindItemEvents();
        }

        function bindItemEvents() {
          document.querySelectorAll(".remove-btn").forEach((btn) => {
            btn.onclick = () => window.cartApi.removeItem(btn.dataset.id);
          });

          document.querySelectorAll(".qty-input").forEach((input) => {
            input.onchange = () => {
              const qty = Number(input.value);
              if (qty <= 0) window.cartApi.removeItem(input.dataset.id);
              else window.cartApi.updateQty(input.dataset.id, qty);
            };
          });
        }

        btnClear.onclick = () => {
          window.cartApi.clearCart();
          formContainer.classList.add("hidden");
          renderCart();
        };

        btnShowForm.onclick = () => {
          if (!window.cartApi.getCount()) {
            payNote.classList.remove("hidden");
            return;
          }
          payNote.classList.add("hidden");
          formContainer.classList.remove("hidden");
          btnShowForm.disabled = true;
        };

        function showModalWompi(
          amount,
          reference,
          signature,
          email,
          name,
          phone
        ) {
          const modal = document.getElementById("modalPago");
          const container = document.getElementById("wompi-container");

          modal.style.display = "flex";
          container.innerHTML = "";

          const script = document.createElement("script");
          script.src = "https://checkout.wompi.co/widget.js";

          script.setAttribute("data-render", "button");
          script.setAttribute(
            "data-public-key",
            "pub_test_qmiRiyHacyTM26FBxEn1Xt4pLu4B2c1S"
          );
          script.setAttribute("data-currency", "COP");
          script.setAttribute("data-amount-in-cents", amount);
          script.setAttribute("data-reference", reference);

          // ‚úÖ FIRMA OBLIGATORIA
          script.setAttribute("data-signature:integrity", signature);

          // ‚úÖ Datos del cliente
          // script.setAttribute(
          //   "data-customer-data",
          //   JSON.stringify({
          //     email: email,
          //     full_name: name,
          //     phone_number: phone,
          //   })
          // );

          script.setAttribute(
            "data-redirect-url",
            "https://tusitio.com/gracias"
          );

          container.appendChild(script);
        }

        function initialPayment() {
          debugger;
          const name = document.getElementById("buyer-name").value;
          const email = document.getElementById("buyer-email").value;
          const phone = document.getElementById("buyer-phone").value;
          if (!name || !email || !phone) {
            alert("Completa todos los datos");
            return;
          }
          const cart = window.cartApi.getCart();
          const products = cart.map((item) => ({
            name: item.name,
            quantity: item.quantity,
            price: item.price,
          }));

          fetch(
            "https://admin.jewelryfashionoficial.com/wp-json/custom-api/v1/create-payment",
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ name, email, phone, products }),
            }
          )
            .then((res) => res.json())
            .then((data) => {
              if (!data.success) {
                alert("Error creando la orden");
                return;
              }
              showModalWompi(
                data.amount,
                data.reference,
                data.signature,
                email,
                name,
                phone
              );
            });
        }

        btnSubmit.onclick = () => {
          if (!window.cartApi.getCount()) return alert("Carrito vac√≠o");
          initialPayment();
        };

        window.addEventListener("cartchange", renderCart);
        renderCart();
      });
    </script>
  </main>
</BaseLayout>
