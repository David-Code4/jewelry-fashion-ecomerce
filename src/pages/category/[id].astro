---
import BaseLayout from "../../layouts/Layout.astro";

export async function getStaticPaths() {
  try {
    const res = await fetch(
      "https://admin.jewelryfashionoficial.com/wp-json/custom-api/v1/api-json/v1/get_categories/?nocache=53244"
    );

    const categories = await res.json();

    return categories.map((cat: any) => ({
      params: { id: String(cat.id) },
    }));
  } catch (error) {
    console.error("Error cargando categorías:", error);
    return [];
  }
}

const { id } = Astro.params;

// Cargar productos por categoría
let products = [];

try {
  const response = await fetch(
    `https://admin.jewelryfashionoficial.com/wp-json/custom-api/v1/api-json/v1/get_products_by_category/${id}`
  );
  products = await response.json();
} catch (error) {
  console.error("Error al cargar productos por categoría:", error);
}

// Cargar categorías para menú
let categories = [];

try {
  const response = await fetch(
    "https://admin.jewelryfashionoficial.com/wp-json/custom-api/v1/api-json/v1/get_categories/?nocache=53244"
  );
  categories = await response.json();
} catch (err) {
  console.error("Error loading categories:", err);
}

let nameCategory = categories.find((cat: any) => Number(cat.id) === Number(id));
---

<BaseLayout>
  <div
    class="relative w-full h-[40vh] min-h-[300px] flex items-center justify-center overflow-hidden"
  >
    <div
      class="absolute inset-0 bg-cover bg-center bg-no-repeat"
      style="background-image: url('https://images.unsplash.com/photo-1515934751635-c81c6bc9a2d8?q=80&w=2070&auto=format&fit=crop');"
    >
      <div class="absolute inset-0 bg-black/50"></div>
      <div
        class="relative w-full h-[40vh] min-h-[300px] flex items-center justify-center overflow-hidden"
      >
        <h1
          class="relative z-10 text-4xl md:text-6xl font-bold text-white text-center tracking-tight drop-shadow-2xl px-4"
        >
          {nameCategory.name}
        </h1>
      </div>
    </div>
  </div>
  <nav class="relative bg-gray-900 pb-7 p-9 text-white">
    <div class="relative md:static w-full">
      <div
        id="menu-desktop"
        class="hidden md:flex md:flex-row md:space-x-12 md:justify-center md:items-center
        md:text-xs md:font-medium md:tracking-widest relative"
      >
        {
          categories.map((item: any) => (
            <div x-data="{ open:false }" class="relative">
              <a
                href={`/category/${item.id}`}
                class="hover:text-primary transition-colors cursor-pointer"
              >
                {item.name}
              </a>
            </div>
          ))
        }
      </div>
    </div>
  </nav>

  <div
    class="relative flex h-auto min-h-screen w-full flex-col bg-background-light dark:bg-[#000000] group/design-root overflow-x-hidden"
  >
    <main class="flex-grow container mx-auto px-4">
      <div
        class="flex flex-col sm:flex-row justify-between items-center py-2 gap-4"
      >
        <button
          class="w-full sm:w-auto flex items-center justify-center gap-x-2 rounded-lg bg-[#2B0001] px-4 py-2 text-white text-sm font-medium leading-normal border border-[#480001]"
        >
          <span class="material-symbols-outlined text-base"></span>
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="24"
            height="24"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
            class="icon icon-tabler icons-tabler-outline icon-tabler-filter-2"
            ><path stroke="none" d="M0 0h24v24H0z" fill="none"></path><path
              d="M4 6h16"></path><path d="M6 12h12"></path><path d="M9 18h6"
            ></path></svg
          >
        </button>
        <div class="relative w-full sm:w-auto">
          <select
            class="appearance-none bg-[#2B0001] border border-[#480001] text-white text-sm rounded-lg block w-full pl-4 pr-10 py-2"
          >
            <option>Más vendidos</option>
            <option>Novedades</option>
            <option>Precio: más bajo a más alto</option>
            <option>Precio: más alto a más bajo</option>
          </select>
          <div
            class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-3 text-white"
          >
            <span class="material-symbols-outlined text-base"></span>
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="24"
              height="24"
              viewBox="0 0 24 24"
              fill="currentColor"
              class="icon icon-tabler icons-tabler-filled icon-tabler-caret-down"
              ><path stroke="none" d="M0 0h24v24H0z" fill="none"></path><path
                d="M18 9c.852 0 1.297 .986 .783 1.623l-.076 .084l-6 6a1 1 0 0 1 -1.32 .083l-.094 -.083l-6 -6l-.083 -.094l-.054 -.077l-.054 -.096l-.017 -.036l-.027 -.067l-.032 -.108l-.01 -.053l-.01 -.06l-.004 -.057v-.118l.005 -.058l.009 -.06l.01 -.052l.032 -.108l.027 -.067l.07 -.132l.065 -.09l.073 -.081l.094 -.083l.077 -.054l.096 -.054l.036 -.017l.067 -.027l.108 -.032l.053 -.01l.06 -.01l.057 -.004l12.059 -.002z"
              ></path></svg
            >
          </div>
        </div>
      </div>
      <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-6 py-6">
        {
          products.map((product: any) => (
            <div class="flex flex-col gap-4 group">
              <div
                class="relative w-full aspect-square rounded-2xl overflow-hidden 
        bg-[#2B0001] shadow-xl shadow-black/30 border border-[#4f0a0a]/40
        transition-all duration-300 group-hover:border-[#850000]/70"
              >
                <div
                  class="w-full h-full bg-center bg-cover 
          transition-transform duration-300 ease-out group-hover:scale-110"
                  style={`background-image: url('${product.image_url}');`}
                  data-alt={product.product_name}
                />

                {product.on_sale ? (
                  <div
                    class="absolute top-2 left-2 
          bg-[#850000] text-white text-[10px] font-bold px-2 py-0.5 rounded-full 
          shadow-md shadow-black/40 border border-white/10"
                  >
                    OFERTA
                  </div>
                ) : null}
              </div>

              <div class="flex flex-col gap-2 px-1 select-none">
                <div>
                  <p class="text-white text-sm font-semibold tracking-wide">
                    {product.product_name}
                  </p>
                  <p class="text-gray-400 text-xs">{product.material}</p>
                </div>

                <div class="flex items-center gap-2 flex-wrap">
                  <p class="text-[#D4B8B8] text-sm font-bold">
                    ${product.price}
                  </p>

                  {product.on_sale ? (
                    <p class="text-gray-600 text-xs line-through">
                      ${product.regular_price}
                    </p>
                  ) : null}
                </div>

                <div class="flex flex-col gap-2 mt-1">
                  <button
                    id={`add-to-cart-btn-${product.id}`}
                    data-product={encodeURIComponent(
                      JSON.stringify(product || {})
                    )}
                    class="flex cursor-pointer w-full items-center justify-center gap-x-2
            rounded-xl border border-[#660000]/40 bg-[#3A0001] 
            px-3 py-2 text-white text-xs font-bold tracking-wide
            transition-all duration-300
            hover:bg-[#660000] hover:border-[#990000]/80
            active:scale-[0.97] active:bg-[#850000]"
                  >
                    <span class="material-symbols-outlined text-base">
                      <svg
                        xmlns="http://www.w3.org/2000/svg"
                        width="24"
                        height="24"
                        viewBox="0 0 24 24"
                        fill="currentColor"
                        class="icon icon-tabler icons-tabler-filled icon-tabler-garden-cart"
                      >
                        <>
                          <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                          <path d="M3.324 3a2 2 0 0 1 1.855 1.258l1.097 2.742h14.724a1 1 0 0 1 .94 1.341l-.046 .106l-2.934 5.871a3.5 3.5 0 1 1 -4.96 3.182l.005 -.192a3.5 3.5 0 0 1 .499 -1.618l-2.446 -.258l-3.446 4.75a2 2 0 0 1 -2.08 .762l-.154 -.044a2 2 0 0 1 -1.378 -1.9v-9.804l-1.679 -4.196h-1.321a1 1 0 0 1 -.993 -.883l-.007 -.117a1 1 0 0 1 1 -1zm14.176 13a1.5 1.5 0 1 0 0 3a1.5 1.5 0 0 0 0 -3m-10.5 -2.498l-.002 5.498l2.783 -3.833a5 5 0 0 1 -2.614 -1.474z" />
                        </>
                      </svg>{" "}
                    </span>
                    Agregar
                  </button>

                  <a
                    href={"/product/" + product.id}
                    class="hidden md:flex w-full items-center justify-center gap-x-2 
                      rounded-xl border border-[#550000]/40 bg-[#4A0001]
                      px-3 py-2 text-xs font-bold text-white tracking-wide
                      transition-all duration-300
                      hover:bg-[#850000] hover:border-[#A40000]/80
                      active:scale-[0.97]"
                  >
                    Ver producto
                  </a>
                </div>
              </div>
            </div>
          ))
        }
      </div>

      <div class="flex items-center justify-between gap-4 py-4 text-white">
        <button
          class="flex items-center justify-center gap-2 rounded-lg border border-[#480001] bg-[#2B0001] p-2 text-sm font-medium disabled:opacity-50"
          disabled=""
        >
          <span class="material-symbols-outlined text-lg">chevron_left</span>
          <span class="hidden sm:inline">Anterior</span>
        </button>
        <p class="text-sm text-gray-400">Página 1 de 5</p>
        <button
          class="flex items-center justify-center gap-2 rounded-lg border border-[#480001] bg-[#2B0001] p-2 text-sm font-medium"
        >
          <span class="hidden sm:inline">Siguiente</span>
          <span class="material-symbols-outlined text-lg">chevron_right</span>
        </button>
      </div>
    </main>
  </div>
</BaseLayout>

<script type="module">
  window.addEventListener("DOMContentLoaded", () => {
    try {
      const allProducts = document.querySelectorAll(
        'button[id^="add-to-cart-btn-"]'
      );
      allProducts.forEach((btn) => {
        const raw = btn.getAttribute("data-product") || "";
        let product = {};
        try {
          product = JSON.parse(decodeURIComponent(raw));
        } catch (e) {
          product = {};
        }
        const payload = {
          id: String(
            product?.id ?? product?.product_id ?? product?.sku ?? "unknown"
          ),
          name: String(product.product_name ?? product.name ?? ""),
          price: Number(product.price ?? 0),
          image: product.image_url ?? product.image ?? "",
          quantity: 1,
        };
        btn.addEventListener("click", function () {
          if (window.cartApi && typeof window.cartApi.addItem === "function") {
            window.cartApi.addItem(payload);
            btn.textContent = "Añadido";
          } else {
            console.warn("cartApi not available");
          }
        });
      });
    } catch (e) {
      console.error(e);
    }

    const categories = [
      // { name: "PIERCING OREJA", link: "/categoria/piercing-oreja" },
      // { name: "PIERCING NARIZ", link: "/categoria/piercing-nariz" },
      // { name: "LUXURY ORO", link: "/categoria/luxury-oro" },
      // { name: "TITANIO", link: "/categoria/titanio" },
      // { name: "COLECCIONES", link: "/categoria/colecciones" },
      // { name: "ACCESORIOS", link: "/categoria/accesorios" },
      // { name: "ARETES", link: "/categoria/aretes" },
    ];

    let index = 0;

    const item = document.getElementById("carousel-item");
    const leftBtn = document.getElementById("cat-left");
    const rightBtn = document.getElementById("cat-right");

    function updateCategoryAnimated() {
      // Fade out
      item.classList.add("opacity-0");

      setTimeout(() => {
        // Cambiar el contenido a un enlace clickeable
        const cat = categories[index];
        item.innerHTML = `<a href="${cat.link}" class="transition-opacity duration-500 opacity-100 text-white">${cat.name}</a>`;

        // Fade in
        item.classList.remove("opacity-0");
      }, 300); // Duración del fade-out
    }

    // Inicializar
    item.classList.add("transition-opacity", "duration-500");
    updateCategoryAnimated();

    // Avance automático cada 4 segundos
    let autoSlide = setInterval(() => {
      index = (index + 1) % categories.length;
      updateCategoryAnimated();
    }, 4000);

    // Reiniciar autoplay al usar flechas
    function resetAutoSlide() {
      clearInterval(autoSlide);
      autoSlide = setInterval(() => {
        index = (index + 1) % categories.length;
        updateCategoryAnimated();
      }, 4000);
    }

    leftBtn.addEventListener("click", () => {
      index = (index - 1 + categories.length) % categories.length;
      updateCategoryAnimated();
      resetAutoSlide();
    });

    rightBtn.addEventListener("click", () => {
      index = (index + 1) % categories.length;
      updateCategoryAnimated();
      resetAutoSlide();
    });
  });
</script>
