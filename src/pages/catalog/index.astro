---
import BaseLayout from "../../layouts/Layout.astro";

let products = [];

// Fetch productos relacionados
try {
  const response = await fetch(
    "https://admin.jewelryfashionoficial.com/wp-json/custom-api/v1/api-json/v1/get_products/home/?nocache=12345"
  );
  products = await response.json();
} catch (err) {
  console.error("Error loading related products:", err);
}
---

<BaseLayout>
  <div
    class="relative flex h-auto min-h-screen w-full flex-col bg-background-light dark:bg-[#000000] group/design-root overflow-x-hidden"
  >
    <main class="flex-grow container mx-auto px-4">
      <h1
        class="text-white tracking-light text-2xl md:text-[32px] font-bold leading-tight text-left pb-3 pt-6"
      >
        Colección Oreja
      </h1>
      <div
        class="flex flex-col sm:flex-row justify-between items-center py-2 gap-4"
      >
        <button
          class="w-full sm:w-auto flex items-center justify-center gap-x-2 rounded-lg bg-[#2B0001] px-4 py-2 text-white text-sm font-medium leading-normal border border-[#480001]"
        >
          <span class="material-symbols-outlined text-base">filter_list</span>
          Filtrar por
        </button>
        <div class="relative w-full sm:w-auto">
          <select
            class="appearance-none bg-[#2B0001] border border-[#480001] text-white text-sm rounded-lg block w-full pl-4 pr-10 py-2"
          >
            <option>Más vendidos</option>
            <option>Novedades</option>
            <option>Precio: más bajo a más alto</option>
            <option>Precio: más alto a más bajo</option>
          </select>
          <div
            class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-3 text-white"
          >
            <span class="material-symbols-outlined text-base">expand_more</span>
          </div>
        </div>
      </div>
      <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4 py-4">
        {
          products.map((product: any) => (
            <div class="flex flex-col gap-3">
              <div
                class="relative w-full bg-center bg-no-repeat aspect-square bg-cover rounded-xl bg-[#2B0001]"
                data-alt={product.product_name}
                style={`background-image: url("${product.image_url}");`}
              >
                {product.on_sale ? (
                  <div class="absolute top-2 left-2 bg-primary text-white text-[10px] font-bold px-2 py-0.5 rounded-full">
                    OFERTA
                  </div>
                ) : null}
              </div>
              <div class="flex flex-col gap-2">
                <div>
                  <p class="text-white text-sm font-semibold leading-tight">
                    {product.product_name}
                  </p>
                  <p class="text-gray-400 text-xs font-normal leading-normal">
                    {product.material}
                  </p>
                </div>
                <div class="flex items-center gap-2 flex-wrap">
                  <p class="text-white text-sm font-bold leading-normal">
                    ${product.price}
                  </p>
                  {product.on_sale ? (
                    <p class="text-gray-500 text-xs font-normal leading-normal line-through">
                      ${product.regular_price}
                    </p>
                  ) : null}
                </div>
                <div class="flex flex-col gap-2">
                  <button
                    id={`add-to-cart-btn-${product.id}`}
                    data-product={encodeURIComponent(
                      JSON.stringify(product || {})
                    )}
                    class="flex cursor-pointer w-full items-center justify-center gap-x-2 rounded-lg bg-[#480001] px-3 py-1.5 text-white text-xs font-bold leading-normal"
                  >
                    <span class="material-symbols-outlined text-base">
                      add_shopping_cart
                    </span>
                    Agregar
                  </button>
                  <a
                    href={product.product_link + product.id}
                    class="hidden md:flex w-full items-center justify-center gap-x-2 rounded-lg bg-primary px-3 py-1.5 text-white text-xs font-bold leading-normal"
                  >
                    Ver
                  </a>
                </div>
              </div>
            </div>
          ))
        }
      </div>
      <div class="flex items-center justify-between gap-4 py-4 text-white">
        <button
          class="flex items-center justify-center gap-2 rounded-lg border border-[#480001] bg-[#2B0001] p-2 text-sm font-medium disabled:opacity-50"
          disabled=""
        >
          <span class="material-symbols-outlined text-lg">chevron_left</span>
          <span class="hidden sm:inline">Anterior</span>
        </button>
        <p class="text-sm text-gray-400">Página 1 de 5</p>
        <button
          class="flex items-center justify-center gap-2 rounded-lg border border-[#480001] bg-[#2B0001] p-2 text-sm font-medium"
        >
          <span class="hidden sm:inline">Siguiente</span>
          <span class="material-symbols-outlined text-lg">chevron_right</span>
        </button>
      </div>
    </main>
  </div>
</BaseLayout>

<script type="module">
  window.addEventListener("DOMContentLoaded", () => {
    try {
      const allProducts = document.querySelectorAll(
        'button[id^="add-to-cart-btn-"]'
      );
      allProducts.forEach((btn) => {
        const raw = btn.getAttribute("data-product") || "";
        let product = {};
        try {
          product = JSON.parse(decodeURIComponent(raw));
        } catch (e) {
          product = {};
        }
        const payload = {
          id: String(
            product?.id ?? product?.product_id ?? product?.sku ?? "unknown"
          ),
          name: String(product.product_name ?? product.name ?? ""),
          price: Number(product.price ?? 0),
          image: product.image_url ?? product.image ?? "",
          quantity: 1,
        };
        btn.addEventListener("click", function () {
          if (window.cartApi && typeof window.cartApi.addItem === "function") {
            window.cartApi.addItem(payload);
            btn.textContent = "Añadido";
          } else {
            console.warn("cartApi not available");
          }
        });
      });
    } catch (e) {
      console.error(e);
    }
  });
</script>
